<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Retro Day Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 12px; background:#f6f6f6; color:#222; }
        h1, h2 { margin: 8px 0; }
        button { cursor:pointer; }
        .cal-header { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
        .calendar { width:100%; max-width: 980px; border:1px solid #bbb; background:#fff; }
        .cal-row { display:flex; }
        .cal-cell { flex:1; min-height:92px; border-right:1px solid #eee; border-top:1px solid #eee; padding:4px; position:relative; }
        .cal-row .cal-cell:last-child { border-right:none; }
        .dow { background:#fafafa; font-weight:bold; text-align:center; padding:6px 0; border-top:none; }
        .date { font-size:11px; color:#555; position:absolute; top:4px; right:6px; pointer-events:none; }
        .badge { margin-top:18px; font-size:11px; display:block; padding:2px 4px; border-left:6px solid #888; background:#f2f2f8; color:#333; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; pointer-events:none; }
        .legend { font-size:12px; margin:8px 0; }
        .panel { background:#fff; border:1px solid #bbb; padding:8px; margin-top:12px; max-width: 980px; }
        table { width:100%; border-collapse:collapse; font-size:13px; }
        th, td { border:1px solid #ddd; padding:6px; text-align:left; }
        th { background:#f4f4f4; }
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
        .modal-inner { width:360px; background:#fff; border:1px solid #999; padding:10px; }
        .row { display:flex; gap:6px; align-items:center; margin:6px 0; }
        label { font-size:12px; min-width:110px; }
        input[type="text"], input[type="number"], select { width:100%; padding:4px; }
        .small { font-size:12px; color:#666; }
        .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
        .capsule { border:1px solid #ccc; padding:2px 6px; border-radius:10px; font-size:11px; display:inline-block; margin-right:6px; }
        .footer { margin-top:8px; font-size:12px; color:#666; }
        .entry-item { background:#f8f8f8; border:1px solid #ddd; padding:8px; margin:4px 0; border-radius:4px; }
        .entry-item .entry-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
        .entry-item .entry-details { font-size:12px; color:#666; }
        .delete-entry { background:#ff4444; color:white; border:none; padding:2px 6px; border-radius:3px; font-size:11px; cursor:pointer; }
        .expense-row { display:flex; gap:4px; align-items:center; margin:4px 0; }
        .expense-row input[type="number"] { width:80px; }
        .expense-row input[type="text"] { flex:1; }
        .expense-row button { background:#ff6666; color:white; border:none; padding:2px 6px; border-radius:3px; font-size:11px; cursor:pointer; }
        .job-track-item { background:#f8f8f8; border:1px solid #ddd; padding:8px; margin:6px 0; border-radius:4px; border-left:4px solid #888; cursor:pointer; transition:background-color 0.2s; }
        .job-track-item:hover { background:#f0f0f0; }
        .job-track-item.profit { border-left-color:#4CAF50; }
        .job-track-item.loss { border-left-color:#f44336; }
        .job-track-item.neutral { border-left-color:#ff9800; }
        .job-track-item.job-color { border-left-color: var(--job-color); }
        .job-track-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
        .job-track-name { font-weight:bold; font-size:13px; }
        .job-track-client { font-size:11px; color:#666; }
        .job-track-stats { font-size:12px; color:#333; }
        .profit-amount { font-weight:bold; font-size:11px; text-align:right; line-height:1.2; }
        .profit-amount.positive { color:#4CAF50; }
        .profit-amount.negative { color:#4CAF50; }
        .profit-amount.neutral { color:#4CAF50; }
        .week-cashflow { background:#f8f8f8; border:1px solid #ddd; padding:8px; margin:6px 0; border-radius:4px; border-left:4px solid #888; }
        .week-cashflow.positive { border-left-color:#4CAF50; }
        .week-cashflow.negative { border-left-color:#f44336; }
        .week-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
        .week-dates { font-weight:bold; font-size:12px; }
        .week-amount { font-weight:bold; font-size:13px; }
        .week-amount.positive { color:#4CAF50; }
        .week-amount.negative { color:#f44336; }
        .week-details { font-size:11px; color:#666; }
    </style>
</head>
<body>
    <div style="display:flex; gap:12px; align-items:flex-start;">
        <div style="flex:1;">
            <div class="cal-header">
                <button id="prev">&lt;</button>
                <h1 id="title" style="flex:1"></h1>
                <button id="next">&gt;</button>
            </div>
            <div class="legend small">Click a day → enter: Customer • Job (color) • Clayton/Ethan hours • Revenue • Expenses → Save</div>
            <div id="calendar" class="calendar"></div>
        </div>
        
        <div style="width:300px; background:#fff; border:1px solid #bbb; padding:12px; border-radius:4px;">
            <h2 style="margin:0 0 12px 0; font-size:16px;">Weekly Cash Flow</h2>
            <div id="weekly-cashflow" style="margin-bottom:16px;">
                <div class="small" style="color:#999; font-style:italic;">Loading...</div>
            </div>
            
            <hr style="margin: 12px 0;">
            
            <h2 style="margin:0 0 12px 0; font-size:16px;">Job Tracking</h2>
            <div id="job-tracking" style="max-height:400px; overflow-y:auto;">
                <div class="small" style="color:#999; font-style:italic;">Loading jobs...</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2 style="margin-top:0">Jobs (last 5)</h2>
        <table id="jobs-table">
            <thead><tr><th>Job</th><th>Client</th><th>Created</th><th>Revenue</th><th>Labor</th><th>Expenses</th><th>Profit</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="panel">
        <h2 style="margin-top:0">Customers</h2>
        <div id="customers-list"></div>
    </div>

    <div class="panel">
        <h2 style="margin-top:0">Day Entries (this month)</h2>
        <table id="days-table">
            <thead><tr><th>Date</th><th>Client</th><th>Job</th><th>Hours</th><th>Revenue</th><th>Expenses</th><th>Profit</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="modal" class="modal">
        <div class="modal-inner" style="width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong id="form-date">Edit Day</strong>
                <button id="close">x</button>
            </div>
            
            <div id="existing-entries" style="margin-bottom: 16px;">
                <h3 style="margin: 8px 0; font-size: 14px;">Existing Entries</h3>
                <div id="entries-list"></div>
            </div>
            
            <hr style="margin: 12px 0;">
            
            <h3 style="margin: 8px 0; font-size: 14px;">Add New Entry</h3>
            <div class="row"><label>Customer</label>
                <select id="customer"></select>
            </div>
            <div class="row"><label>New Customer</label><input id="newCustomer" type="text" placeholder="(optional)"></div>

            <div class="row"><label>Job</label>
                <select id="job"></select>
            </div>
            <div class="row"><label>New Job</label><input id="newJob" type="text" placeholder="(optional)"></div>
            <div class="row"><label>Job Color</label><input id="jobColor" type="color" value="#2f7afe"></div>

            <div class="row"><label>Clayton hrs</label><input id="hrsC" type="number" step="0.1" min="0" value="0"></div>
            <div class="row"><label>Ethan hrs</label><input id="hrsE" type="number" step="0.1" min="0" value="0"></div>

            <div class="row"><label>Revenue $</label><input id="revenue" type="number" step="0.01" min="0" value="0"></div>
            
            <div style="margin: 12px 0;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <strong style="font-size:13px;">Expenses</strong>
                    <button id="add-expense-row" style="font-size:11px; padding:3px 8px;">+ Add Expense</button>
                </div>
                <div id="expenses-list" style="max-height:150px; overflow-y:auto;"></div>
            </div>

            <div class="actions">
                <button id="add-entry">Add Entry</button>
                <button id="save">Done</button>
            </div>
            <div class="footer small">Employees default wages: Clayton $50/h, Ethan $25/h (all hours billable)</div>
        </div>
    </div>

    <div id="job-edit-modal" class="modal">
        <div class="modal-inner" style="width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong id="job-edit-title">Edit Job</strong>
                <button id="job-edit-close">x</button>
            </div>
            
            <div class="row"><label>Job Name</label><input id="edit-job-name" type="text"></div>
            <div class="row"><label>Customer</label>
                <select id="edit-job-customer"></select>
            </div>
            <div class="row"><label>Job Color</label><input id="edit-job-color" type="color" value="#2f7afe"></div>
            
            <hr style="margin: 12px 0;">
            <h3 style="margin: 8px 0; font-size: 14px;">Adjust Hours (Cash Flow)</h3>
            <div class="row"><label>Clayton Hours</label><input id="edit-clayton-hours" type="number" step="0.1" min="0" value="0"></div>
            <div class="row"><label>Ethan Hours</label><input id="edit-ethan-hours" type="number" step="0.1" min="0" value="0"></div>
            <div class="small" style="color:#666; margin-bottom:8px;">Clayton: $50/hour cash flow • Ethan: $25/hour cash flow</div>
            
            <hr style="margin: 12px 0;">
            <div style="margin: 12px 0;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <strong style="font-size:13px;">Job Expenses (Drawdowns/Investments)</strong>
                    <button id="add-job-expense-row" style="font-size:11px; padding:3px 8px;">+ Add Expense</button>
                </div>
                <div id="job-expenses-list" style="max-height:150px; overflow-y:auto;"></div>
            </div>

            <div class="actions">
                <button id="save-job-edit">Save Changes</button>
                <button id="delete-job" style="background:#ff4444; color:white;">Delete Job</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const $ = (id) => document.getElementById(id);
        const state = {
            current: new Date(),
            selectedISO: null,
            expenseRows: [],
            editingJobId: null,
            jobExpenseRows: []
        };

        // Minimal storage helpers
        function load(key, fallback) {
            try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
        }
        function save(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

        function getCustomers() { return load('customers', []); }
        function setCustomers(v) { save('customers', v); }
        function getJobs() { return load('jobs', []); }
        function setJobs(v) { save('jobs', v); }
        function getDays() { return load('dayEntries', {}); }
        function setDays(v) { save('dayEntries', v); }
        
        // Helper to get entries for a specific day
        function getDayEntries(iso) {
            const days = getDays();
            const data = days[iso];
            
            // Handle backward compatibility: convert old single-entry format to array
            if (data && !Array.isArray(data)) {
                // Old format detected, convert to array
                const entries = [data];
                setDayEntries(iso, entries);
                return entries;
            }
            
            return data || [];
        }
        
        // Helper to save entries for a specific day
        function setDayEntries(iso, entries) {
            const days = getDays();
            days[iso] = entries;
            setDays(days);
        }

        // Employees fixed
        const EMPLOYEES = [
            { id:'emp_clayton', name:'Clayton', wage:50 },
            { id:'emp_ethan', name:'Ethan', wage:25 }
        ];

        function ymd(date) { return date.toISOString().split('T')[0]; }

        function renderCalendar() {
            const year = state.current.getFullYear();
            const month = state.current.getMonth();
            const title = new Date(year, month, 1).toLocaleDateString(undefined, { month:'long', year:'numeric' });
            $('title').textContent = title;

            const first = new Date(year, month, 1);
            const start = new Date(first);
            start.setDate(first.getDate() - first.getDay());
            const days = [];
            for (let i=0; i<42; i++) {
                const d = new Date(start); d.setDate(start.getDate()+i); days.push(d);
            }
            const daysEl = document.createElement('div');
            // Header row
            let header = document.createElement('div'); header.className='cal-row';
            ;['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(w=>{ const c=document.createElement('div'); c.className='cal-cell dow'; c.textContent=w; header.appendChild(c); });
            daysEl.appendChild(header);
            // 6 weeks rows
            for (let w=0; w<6; w++) {
                const row = document.createElement('div'); row.className='cal-row';
                for (let d=0; d<7; d++) {
                    const date = days[w*7+d];
                    const cell = document.createElement('div'); cell.className='cal-cell';
                    if (date.getMonth()!==month) cell.style.background='#fbfbfb';
                    const num = document.createElement('div'); num.className='date'; num.textContent = date.getDate(); cell.appendChild(num);

                    // badges from saved entries
                    const iso = ymd(date);
                    const entries = getDayEntries(iso);
                    if (entries.length > 0) {
                        const jobs = getJobs();
                        entries.forEach((entry, idx) => {
                            const job = jobs.find(j => j.id === entry.jobId);
                            const badge = document.createElement('span');
                            badge.className='badge';
                            const color = (job && job.color) ? job.color : '#888';
                            badge.style.borderLeftColor = color;
                            const hours = (entry.manHours||[]).reduce((s,m)=>s+(m.hours||0),0);
                            
                            // Calculate cash flow from hours
                            const claytonHours = (entry.manHours||[]).find(m=>m.employeeId==='emp_clayton')?.hours || 0;
                            const ethanHours = (entry.manHours||[]).find(m=>m.employeeId==='emp_ethan')?.hours || 0;
                            const cashFlow = (claytonHours * 50) + (ethanHours * 25);
                            
                            badge.textContent = `${job ? job.name : 'No Job'} • ${hours}h • +$${cashFlow}`;
                            if (entries.length > 1) badge.textContent += ` (${idx+1})`;
                            cell.appendChild(badge);
                        });
                    }

                    cell.addEventListener('click', ()=> openModal(date));
                    row.appendChild(cell);
                }
                daysEl.appendChild(row);
            }
            const cal = $('calendar');
            cal.innerHTML = '';
            cal.appendChild(daysEl);

            renderJobsTable();
            renderCustomersList();
            renderDaysTable(year, month);
            renderJobTracking();
            renderWeeklyCashFlow();
        }

        function ensureCustomer(name) {
            let customers = getCustomers();
            let c = customers.find(x => x.name.toLowerCase() === name.toLowerCase());
            if (!c) { c = { id: `cus_${Date.now()}`, name }; customers.push(c); setCustomers(customers); }
            return c;
        }
        function ensureJob(clientId, name, color) {
            let jobs = getJobs();
            let j = jobs.find(x => x.clientId===clientId && x.name.toLowerCase()===name.toLowerCase());
            if (!j) { j = { id:`job_${Date.now()}`, name, clientId, color: color||'#2f7afe', created: new Date().toISOString() }; jobs.push(j); setJobs(jobs); }
            return j;
        }

        function openModal(date) {
            state.selectedISO = ymd(date);
            $('form-date').textContent = `Day: ${date.toLocaleDateString()}`;
            
            // Show existing entries
            renderExistingEntries();
            
            // populate selects for new entry
            populateSelects();
            
            // Clear form for new entry
            clearForm();

            $('modal').style.display = 'flex';
        }
        
        function renderExistingEntries() {
            const entries = getDayEntries(state.selectedISO);
            const container = $('entries-list');
            container.innerHTML = '';
            
            if (entries.length === 0) {
                container.innerHTML = '<div class="small" style="color:#999; font-style:italic;">No entries yet</div>';
                return;
            }
            
            const customers = getCustomers();
            const jobs = getJobs();
            
            entries.forEach((entry, idx) => {
                const div = document.createElement('div');
                div.className = 'entry-item';
                
                const customer = customers.find(c => c.id === entry.clientId);
                const job = jobs.find(j => j.id === entry.jobId);
                const hours = (entry.manHours||[]).reduce((s,m)=>s+(m.hours||0),0);
                const revenue = entry.revenue||0;
                const totalExpenses = (entry.expenses||[]).reduce((s,e)=>s+(e.amount||0),0);
                const profit = revenue - (entry.totals?.labor||0) - totalExpenses;
                
                // Build expenses breakdown if there are expenses
                let expensesDetail = '';
                if (entry.expenses && entry.expenses.length > 0) {
                    const expList = entry.expenses.map(e => `${e.note}: $${e.amount.toFixed(2)}`).join(', ');
                    expensesDetail = `<div style="font-size:11px; color:#888; margin-top:2px;">Expenses: ${expList}</div>`;
                }
                
                div.innerHTML = `
                    <div class="entry-header">
                        <strong>${job ? job.name : 'No Job'} (${customer ? customer.name : 'No Customer'})</strong>
                        <button class="delete-entry" onclick="deleteEntry(${idx})">Delete</button>
                    </div>
                    <div class="entry-details">
                        ${hours}h • $${revenue} revenue • $${totalExpenses.toFixed(2)} expenses • $${profit.toFixed(2)} profit
                        ${expensesDetail}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function populateSelects() {
            const customers = getCustomers();
            const jobs = getJobs();
            const custSel = $('customer'); custSel.innerHTML = '';
            const jobSel = $('job'); jobSel.innerHTML = '';
            const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='(select)'; custSel.appendChild(opt0);
            customers.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; custSel.appendChild(o); });
            const optJ0 = document.createElement('option'); optJ0.value=''; optJ0.textContent='(select)'; jobSel.appendChild(optJ0);

            custSel.onchange = () => {
                const cid = custSel.value; jobSel.innerHTML=''; const o0=document.createElement('option'); o0.value=''; o0.textContent='(select)'; jobSel.appendChild(o0);
                jobs.filter(j=>j.clientId===cid).forEach(j=>{ const o=document.createElement('option'); o.value=j.id; o.textContent=j.name; jobSel.appendChild(o); });
            };
        }
        
        function clearForm() {
            $('customer').value = '';
            $('newCustomer').value = '';
            $('job').innerHTML = '<option value="">(select)</option>';
            $('newJob').value = '';
            $('jobColor').value = '#2f7afe';
            $('hrsC').value = '0';
            $('hrsE').value = '0';
            $('revenue').value = '0';
            state.expenseRows = [];
            renderExpenseRows();
        }
        
        function addExpenseRow(amount = '', note = '') {
            state.expenseRows.push({ amount, note, id: Date.now() });
            renderExpenseRows();
        }
        
        function removeExpenseRow(id) {
            state.expenseRows = state.expenseRows.filter(r => r.id !== id);
            renderExpenseRows();
        }
        
        function renderExpenseRows() {
            const container = $('expenses-list');
            container.innerHTML = '';
            
            if (state.expenseRows.length === 0) {
                container.innerHTML = '<div class="small" style="color:#999; font-style:italic; padding:4px;">No expenses yet</div>';
                return;
            }
            
            state.expenseRows.forEach((row, idx) => {
                const div = document.createElement('div');
                div.className = 'expense-row';
                div.innerHTML = `
                    <span style="font-size:11px; color:#666;">$</span>
                    <input type="number" step="0.01" min="0" value="${row.amount}" 
                           onchange="updateExpenseRow(${row.id}, 'amount', this.value)" 
                           placeholder="Amount">
                    <input type="text" value="${row.note}" 
                           onchange="updateExpenseRow(${row.id}, 'note', this.value)" 
                           placeholder="Description (e.g., materials, gas, etc.)">
                    <button onclick="removeExpenseRow(${row.id})">×</button>
                `;
                container.appendChild(div);
            });
        }
        
        function updateExpenseRow(id, field, value) {
            const row = state.expenseRows.find(r => r.id === id);
            if (row) row[field] = value;
        }
        
        // Make expense functions global for onclick handlers
        window.removeExpenseRow = removeExpenseRow;
        window.updateExpenseRow = updateExpenseRow;
        
        // Function to update all existing entries with new wage rates
        function updateAllWageRates() {
            const days = getDays();
            let updated = false;
            
            Object.keys(days).forEach(date => {
                const entries = getDayEntries(date);
                entries.forEach(entry => {
                    if (entry.manHours) {
                        entry.manHours.forEach(manHour => {
                            // Update wage rates based on employee ID
                            if (manHour.employeeId === 'emp_clayton' && manHour.wage !== 50) {
                                manHour.wage = 50;
                                manHour.cost = manHour.hours * 50;
                                updated = true;
                            } else if (manHour.employeeId === 'emp_ethan' && manHour.wage !== 25) {
                                manHour.wage = 25;
                                manHour.cost = manHour.hours * 25;
                                updated = true;
                            }
                        });
                        
                        // Recalculate totals if wages were updated
                        if (updated) {
                            const labor = entry.manHours.reduce((sum, m) => sum + (m.cost || 0), 0);
                            const expenses = (entry.expenses || []).reduce((sum, e) => sum + (e.amount || 0), 0);
                            const revenue = entry.revenue || 0;
                            const profit = revenue - labor - expenses;
                            
                            entry.totals = {
                                labor,
                                expenses,
                                revenue,
                                profit
                            };
                        }
                    }
                });
                
                if (updated) {
                    setDayEntries(date, entries);
                }
            });
            
            if (updated) {
                console.log('Updated all entries with new wage rates');
                renderCalendar();
                renderJobTracking();
            }
        }
        
        // Job expense management functions
        function addJobExpenseRow(amount = '', note = '') {
            state.jobExpenseRows.push({ amount, note, id: Date.now() });
            renderJobExpenseRows();
        }
        
        function removeJobExpenseRow(id) {
            state.jobExpenseRows = state.jobExpenseRows.filter(r => r.id !== id);
            renderJobExpenseRows();
        }
        
        function renderJobExpenseRows() {
            const container = $('job-expenses-list');
            container.innerHTML = '';
            
            if (state.jobExpenseRows.length === 0) {
                container.innerHTML = '<div class="small" style="color:#999; font-style:italic; padding:4px;">No expenses yet</div>';
                return;
            }
            
            state.jobExpenseRows.forEach((row, idx) => {
                const div = document.createElement('div');
                div.className = 'expense-row';
                div.innerHTML = `
                    <span style="font-size:11px; color:#666;">$</span>
                    <input type="number" step="0.01" min="0" value="${row.amount}" 
                           onchange="updateJobExpenseRow(${row.id}, 'amount', this.value)" 
                           placeholder="Amount">
                    <input type="text" value="${row.note}" 
                           onchange="updateJobExpenseRow(${row.id}, 'note', this.value)" 
                           placeholder="Description (e.g., materials, equipment, etc.)">
                    <button onclick="removeJobExpenseRow(${row.id})">×</button>
                `;
                container.appendChild(div);
            });
        }
        
        function updateJobExpenseRow(id, field, value) {
            const row = state.jobExpenseRows.find(r => r.id === id);
            if (row) row[field] = value;
        }
        
        // Make job expense functions global for onclick handlers
        window.removeJobExpenseRow = removeJobExpenseRow;
        window.updateJobExpenseRow = updateJobExpenseRow;
        
        // Job editing functions
        function openJobEditModal(jobId) {
            const jobs = getJobs();
            const customers = getCustomers();
            const job = jobs.find(j => j.id === jobId);
            
            if (!job) return;
            
            // Store the job ID for editing
            state.editingJobId = jobId;
            
            // Populate the form
            $('edit-job-name').value = job.name;
            $('edit-job-color').value = job.color || '#2f7afe';
            
            // Calculate total hours for this job
            const days = getDays();
            let claytonHours = 0;
            let ethanHours = 0;
            let jobExpenses = [];
            
            Object.values(days).forEach(entries => {
                const entryList = Array.isArray(entries) ? entries : [entries];
                entryList.forEach(entry => {
                    if (entry && entry.jobId === jobId) {
                        // Sum up hours
                        if (entry.manHours) {
                            entry.manHours.forEach(mh => {
                                if (mh.employeeId === 'emp_clayton') {
                                    claytonHours += mh.hours || 0;
                                } else if (mh.employeeId === 'emp_ethan') {
                                    ethanHours += mh.hours || 0;
                                }
                            });
                        }
                        
                        // Collect expenses
                        if (entry.expenses) {
                            entry.expenses.forEach(exp => {
                                jobExpenses.push({ amount: exp.amount, note: exp.note, id: Date.now() + Math.random() });
                            });
                        }
                    }
                });
            });
            
            $('edit-clayton-hours').value = claytonHours;
            $('edit-ethan-hours').value = ethanHours;
            
            // Set up job expenses
            state.jobExpenseRows = jobExpenses;
            renderJobExpenseRows();
            
            // Populate customer dropdown
            const customerSelect = $('edit-job-customer');
            customerSelect.innerHTML = '';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                if (customer.id === job.clientId) {
                    option.selected = true;
                }
                customerSelect.appendChild(option);
            });
            
            $('job-edit-modal').style.display = 'flex';
        }
        
        function closeJobEditModal() {
            $('job-edit-modal').style.display = 'none';
            state.editingJobId = null;
        }
        
        function saveJobEdit() {
            if (!state.editingJobId) return;
            
            const jobs = getJobs();
            const jobIndex = jobs.findIndex(j => j.id === state.editingJobId);
            
            if (jobIndex === -1) return;
            
            const newName = $('edit-job-name').value.trim();
            const newCustomerId = $('edit-job-customer').value;
            const newColor = $('edit-job-color').value;
            const newClaytonHours = parseFloat($('edit-clayton-hours').value) || 0;
            const newEthanHours = parseFloat($('edit-ethan-hours').value) || 0;
            
            if (!newName) {
                alert('Job name is required');
                return;
            }
            
            if (!newCustomerId) {
                alert('Please select a customer');
                return;
            }
            
            // Update the job
            jobs[jobIndex].name = newName;
            jobs[jobIndex].clientId = newCustomerId;
            jobs[jobIndex].color = newColor;
            
            setJobs(jobs);
            
            // Update all calendar entries that reference this job
            updateJobInCalendar(state.editingJobId, newName, newColor, newClaytonHours, newEthanHours);
            
            closeJobEditModal();
            renderCalendar();
            renderJobTracking();
        }
        
        function deleteJob() {
            if (!state.editingJobId) return;
            
            if (!confirm('Are you sure you want to delete this job? This will remove it from all calendar entries.')) {
                return;
            }
            
            const jobs = getJobs();
            const jobIndex = jobs.findIndex(j => j.id === state.editingJobId);
            
            if (jobIndex === -1) return;
            
            // Remove the job
            jobs.splice(jobIndex, 1);
            setJobs(jobs);
            
            // Remove job references from calendar entries
            removeJobFromCalendar(state.editingJobId);
            
            closeJobEditModal();
            renderCalendar();
            renderJobTracking();
        }
        
        function updateJobInCalendar(jobId, newName, newColor, newClaytonHours, newEthanHours) {
            const days = getDays();
            const totalCurrentHours = newClaytonHours + newEthanHours;
            
            Object.keys(days).forEach(date => {
                const entries = getDayEntries(date);
                entries.forEach(entry => {
                    if (entry.jobId === jobId) {
                        // Update job name and color in the entry
                        entry.jobName = newName;
                        entry.jobColor = newColor;
                        
                        // Update hours proportionally across all entries for this job
                        if (entry.manHours && totalCurrentHours > 0) {
                            const currentClaytonHours = entry.manHours.find(mh => mh.employeeId === 'emp_clayton')?.hours || 0;
                            const currentEthanHours = entry.manHours.find(mh => mh.employeeId === 'emp_ethan')?.hours || 0;
                            const currentTotalHours = currentClaytonHours + currentEthanHours;
                            
                            if (currentTotalHours > 0) {
                                // Calculate proportional adjustment
                                const claytonRatio = currentClaytonHours / currentTotalHours;
                                const ethanRatio = currentEthanHours / currentTotalHours;
                                
                                // Update hours proportionally
                                const newClaytonEntryHours = newClaytonHours * claytonRatio;
                                const newEthanEntryHours = newEthanHours * ethanRatio;
                                
                                entry.manHours.forEach(mh => {
                                    if (mh.employeeId === 'emp_clayton') {
                                        mh.hours = newClaytonEntryHours;
                                        mh.cost = newClaytonEntryHours * 50;
                                    } else if (mh.employeeId === 'emp_ethan') {
                                        mh.hours = newEthanEntryHours;
                                        mh.cost = newEthanEntryHours * 25;
                                    }
                                });
                                
                                // Recalculate totals
                                const labor = entry.manHours.reduce((sum, m) => sum + (m.cost || 0), 0);
                                const expenses = (entry.expenses || []).reduce((sum, e) => sum + (e.amount || 0), 0);
                                const revenue = entry.revenue || 0;
                                const profit = revenue - labor - expenses;
                                
                                entry.totals = {
                                    labor,
                                    expenses,
                                    revenue,
                                    profit
                                };
                            }
                        }
                        
                        // Update expenses from job expense rows
                        const jobExpenses = state.jobExpenseRows
                            .filter(r => parseFloat(r.amount) > 0)
                            .map(r => ({ 
                                amount: parseFloat(r.amount), 
                                note: r.note.trim() || 'Job expense' 
                            }));
                        
                        entry.expenses = jobExpenses;
                        
                        // Recalculate totals with new expenses
                        const labor = (entry.manHours || []).reduce((sum, m) => sum + (m.cost || 0), 0);
                        const expenses = jobExpenses.reduce((sum, e) => sum + e.amount, 0);
                        const revenue = entry.revenue || 0;
                        const profit = revenue - labor - expenses;
                        
                        entry.totals = {
                            labor,
                            expenses,
                            revenue,
                            profit
                        };
                    }
                });
                setDayEntries(date, entries);
            });
        }
        
        function removeJobFromCalendar(jobId) {
            const days = getDays();
            Object.keys(days).forEach(date => {
                const entries = getDayEntries(date);
                const filteredEntries = entries.filter(entry => entry.jobId !== jobId);
                if (filteredEntries.length !== entries.length) {
                    setDayEntries(date, filteredEntries);
                }
            });
        }
        
        function deleteEntry(index) {
            const entries = getDayEntries(state.selectedISO);
            entries.splice(index, 1);
            setDayEntries(state.selectedISO, entries);
            renderExistingEntries();
            renderCalendar();
            renderJobTracking();
            renderWeeklyCashFlow();
        }
        
        // Make deleteEntry global for onclick handlers
        window.deleteEntry = deleteEntry;

        function closeModal() { $('modal').style.display = 'none'; }

        function addEntry() {
            const newCustName = $('newCustomer').value.trim();
            const custSel = $('customer').value;
            let customerId = custSel;
            if (!customerId && newCustName) customerId = ensureCustomer(newCustName).id;
            if (!customerId) { alert('Select or enter a customer'); return; }

            const newJobName = $('newJob').value.trim();
            const jobSel = $('job').value;
            let jobId = jobSel;
            if (!jobId && newJobName) jobId = ensureJob(customerId, newJobName, $('jobColor').value).id;
            if (!jobId) { alert('Select or enter a job'); return; }

            const hrsC = parseFloat($('hrsC').value)||0;
            const hrsE = parseFloat($('hrsE').value)||0;
            const revenue = parseFloat($('revenue').value)||0;
            
            // Collect expenses from expense rows
            const expenses = state.expenseRows
                .filter(r => parseFloat(r.amount) > 0)
                .map(r => ({ 
                    amount: parseFloat(r.amount), 
                    note: r.note.trim() || 'No description' 
                }));

            const labor = hrsC*EMPLOYEES[0].wage + hrsE*EMPLOYEES[1].wage;
            const totalExpenses = expenses.reduce((s,e)=>s+e.amount,0);
            const profit = revenue - labor - totalExpenses;

            const newEntry = {
                id: `entry_${Date.now()}`,
                date: state.selectedISO,
                clientId: customerId,
                jobId,
                manHours:[
                    { employeeId: EMPLOYEES[0].id, hours: hrsC, wage: EMPLOYEES[0].wage, cost: hrsC*EMPLOYEES[0].wage },
                    { employeeId: EMPLOYEES[1].id, hours: hrsE, wage: EMPLOYEES[1].wage, cost: hrsE*EMPLOYEES[1].wage }
                ],
                revenue,
                expenses,
                totals:{ labor, expenses: totalExpenses, revenue, profit }
            };
            
            const entries = getDayEntries(state.selectedISO);
            entries.push(newEntry);
            setDayEntries(state.selectedISO, entries);
            
            // Clear form and refresh display
            clearForm();
            renderExistingEntries();
            renderCalendar();
            renderJobTracking();
            renderWeeklyCashFlow();
        }
        
        function saveDay() {
            closeModal();
        }

        function renderJobsTable() {
            const jobs = getJobs().slice().sort((a,b)=>new Date(b.created)-new Date(a.created));
            const last5 = jobs.slice(0,5);
            const days = getDays();
            const tbody = $('jobs-table').querySelector('tbody'); tbody.innerHTML = '';
            last5.forEach(job => {
                const stats = jobStats(job.id, days);
                const tr = document.createElement('tr');
                const customer = getCustomers().find(c=>c.id===job.clientId);
                tr.innerHTML = `<td>${job.name}</td><td>${customer?customer.name:''}</td><td>${new Date(job.created).toLocaleDateString()}</td>`+
                    `<td>$${stats.revenue.toFixed(2)}</td><td>$${stats.labor.toFixed(2)}</td><td>$${stats.expenses.toFixed(2)}</td>`+
                    `<td>$${(stats.revenue-stats.labor-stats.expenses).toFixed(2)}</td>`;
                tbody.appendChild(tr);
            });
        }

        function jobStats(jobId, daysMap) {
            let revenue=0, labor=0, expenses=0;
            Object.values(daysMap).forEach(entries => {
                if (Array.isArray(entries)) {
                    entries.forEach(d => {
                        if (d.jobId===jobId) {
                            revenue += d.revenue||0;
                            labor   += (d.manHours||[]).reduce((s,m)=>s+(m.cost||0),0);
                            expenses+= (d.expenses||[]).reduce((s,e)=>s+(e.amount||0),0);
                        }
                    });
                } else if (entries.jobId===jobId) {
                    // Handle old single-entry format for backward compatibility
                    revenue += entries.revenue||0;
                    labor   += (entries.manHours||[]).reduce((s,m)=>s+(m.cost||0),0);
                    expenses+= (entries.expenses||[]).reduce((s,e)=>s+(e.amount||0),0);
                }
            });
            return { revenue, labor, expenses };
        }

        function renderCustomersList() {
            const wrap = $('customers-list'); wrap.innerHTML = '';
            const customers = getCustomers();
            if (customers.length === 0) { wrap.textContent = '(no customers yet)'; return; }
            customers.forEach(c => {
                const span = document.createElement('span'); span.className='capsule'; span.textContent=c.name; wrap.appendChild(span);
            });
        }

        function renderDaysTable(year, month) {
            const start = new Date(year, month, 1);
            const end = new Date(year, month+1, 0);
            const days = getDays();
            const tbody = $('days-table').querySelector('tbody'); tbody.innerHTML='';
            const customers = getCustomers(); const jobs = getJobs();
            for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) {
                const iso = ymd(d);
                const entries = getDayEntries(iso);
                if (entries.length === 0) continue;
                
                entries.forEach((entry, idx) => {
                    const client = customers.find(c=>c.id===entry.clientId);
                    const job = jobs.find(j=>j.id===entry.jobId);
                    const hours = (entry.manHours||[]).reduce((s,m)=>s+(m.hours||0),0);
                    const tr = document.createElement('tr');
                    const dateStr = idx === 0 ? d.toLocaleDateString() : '';
                    tr.innerHTML = `<td>${dateStr}</td><td>${client?client.name:''}</td><td>${job?job.name:''}</td>`+
                        `<td>${hours}</td><td>$${(entry.revenue||0).toFixed(2)}</td>`+
                        `<td>$${((entry.expenses||[]).reduce((s,e)=>s+(e.amount||0),0)).toFixed(2)}</td>`+
                        `<td>$${(entry.totals?entry.totals.profit:((entry.revenue||0) - (entry.manHours||[]).reduce((s,m)=>s+(m.cost||0),0) - (entry.expenses||[]).reduce((s,e)=>s+(e.amount||0),0))).toFixed(2)}</td>`;
                    tbody.appendChild(tr);
                });
            }
        }
        
        function renderJobTracking() {
            const container = $('job-tracking');
            const jobs = getJobs();
            const customers = getCustomers();
            const days = getDays();
            
            if (jobs.length === 0) {
                container.innerHTML = '<div class="small" style="color:#999; font-style:italic;">No jobs yet</div>';
                return;
            }
            
            container.innerHTML = '';
            
            // Sort jobs by most recent activity (based on last entry date)
            const jobsWithStats = jobs.map(job => {
                const stats = jobStats(job.id, days);
                const customer = customers.find(c => c.id === job.clientId);
                
                // Find the most recent entry for this job
                let lastActivity = null;
                Object.entries(days).forEach(([date, entries]) => {
                    const entryList = Array.isArray(entries) ? entries : [entries];
                    entryList.forEach(entry => {
                        if (entry && entry.jobId === job.id) {
                            if (!lastActivity || date > lastActivity) {
                                lastActivity = date;
                            }
                        }
                    });
                });
                
                return {
                    ...job,
                    customer,
                    stats,
                    lastActivity,
                    profit: stats.revenue - stats.labor - stats.expenses
                };
            });
            
            // Sort by last activity (most recent first), then by profit
            jobsWithStats.sort((a, b) => {
                if (a.lastActivity && b.lastActivity) {
                    return new Date(b.lastActivity) - new Date(a.lastActivity);
                }
                if (a.lastActivity) return -1;
                if (b.lastActivity) return 1;
                return b.profit - a.profit;
            });
            
            jobsWithStats.forEach(job => {
                const div = document.createElement('div');
                div.className = 'job-track-item job-color';
                
                // Use the job's color instead of profit/loss status
                div.style.setProperty('--job-color', job.color || '#888');
                
                // Always show as gross profit in green
                let profitClass = 'positive';
                
                const totalHours = Object.values(days).reduce((total, entries) => {
                    const entryList = Array.isArray(entries) ? entries : [entries];
                    return total + entryList.reduce((sum, entry) => {
                        if (entry && entry.jobId === job.id) {
                            return sum + (entry.manHours || []).reduce((h, m) => h + (m.hours || 0), 0);
                        }
                        return sum;
                    }, 0);
                }, 0);
                
                div.innerHTML = `
                    <div class="job-track-header">
                        <div>
                            <div class="job-track-name">${job.name}</div>
                            <div class="job-track-client">${job.customer ? job.customer.name : 'No Customer'}</div>
                        </div>
                        <div class="profit-amount ${profitClass}">Gross Profit<br/>+$${Math.abs(job.profit).toFixed(2)}</div>
                    </div>
                    <div class="job-track-stats">
                        <div>Revenue: $${job.stats.revenue.toFixed(2)}</div>
                        <div>Labor: $${job.stats.labor.toFixed(2)} (${totalHours.toFixed(1)}h)</div>
                        <div>Expenses: $${job.stats.expenses.toFixed(2)}</div>
                        ${job.lastActivity ? `<div style="font-size:10px; color:#888; margin-top:2px;">Last: ${new Date(job.lastActivity).toLocaleDateString()}</div>` : ''}
                    </div>
                `;
                
                // Add click event to edit the job
                div.addEventListener('click', () => openJobEditModal(job.id));
                
                container.appendChild(div);
            });
        }
        
        function renderWeeklyCashFlow() {
            const container = $('weekly-cashflow');
            const days = getDays();
            const year = state.current.getFullYear();
            const month = state.current.getMonth();
            
            // Get the first day of the month and calculate weeks
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(firstDay.getDate() - firstDay.getDay()); // Start from Sunday
            
            const weeks = [];
            for (let i = 0; i < 6; i++) {
                const weekStart = new Date(startDate);
                weekStart.setDate(startDate.getDate() + (i * 7));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                // Only show weeks that have days in the current month
                if (weekEnd.getMonth() >= month - 1 && weekStart.getMonth() <= month + 1) {
                    weeks.push({ start: new Date(weekStart), end: new Date(weekEnd) });
                }
            }
            
            container.innerHTML = '';
            
            weeks.forEach(week => {
                let totalCashFlow = 0;
                let totalHours = 0;
                let dayCount = 0;
                
                // Calculate cash flow for this week
                for (let d = new Date(week.start); d <= week.end; d.setDate(d.getDate() + 1)) {
                    const iso = ymd(d);
                    const entries = getDayEntries(iso);
                    
                    if (entries.length > 0) {
                        dayCount++;
                        entries.forEach(entry => {
                            if (entry.manHours) {
                                const claytonHours = entry.manHours.find(m => m.employeeId === 'emp_clayton')?.hours || 0;
                                const ethanHours = entry.manHours.find(m => m.employeeId === 'emp_ethan')?.hours || 0;
                                const weekCashFlow = (claytonHours * 50) + (ethanHours * 25);
                                totalCashFlow += weekCashFlow;
                                totalHours += claytonHours + ethanHours;
                            }
                        });
                    }
                }
                
                // Only show weeks with activity
                if (dayCount > 0) {
                    const div = document.createElement('div');
                    div.className = 'week-cashflow';
                    
                    const isPositive = totalCashFlow >= 0;
                    div.classList.add(isPositive ? 'positive' : 'negative');
                    
                    const weekLabel = `${week.start.getMonth() + 1}/${week.start.getDate()}-${week.end.getMonth() + 1}/${week.end.getDate()}`;
                    
                    div.innerHTML = `
                        <div class="week-header">
                            <div class="week-dates">Week ${weekLabel}</div>
                            <div class="week-amount ${isPositive ? 'positive' : 'negative'}">
                                ${isPositive ? '+' : ''}$${totalCashFlow.toFixed(0)}
                            </div>
                        </div>
                        <div class="week-details">
                            ${totalHours.toFixed(1)}h • ${dayCount} day${dayCount !== 1 ? 's' : ''}
                        </div>
                    `;
                    
                    container.appendChild(div);
                }
            });
            
            if (container.children.length === 0) {
                container.innerHTML = '<div class="small" style="color:#999; font-style:italic;">No activity this month</div>';
            }
        }

        // Events
        $('prev').onclick = ()=>{ state.current.setMonth(state.current.getMonth()-1); renderCalendar(); };
        $('next').onclick = ()=>{ state.current.setMonth(state.current.getMonth()+1); renderCalendar(); };
        $('close').onclick = closeModal;
        $('add-entry').onclick = addEntry;
        $('add-expense-row').onclick = ()=> addExpenseRow();
        $('save').onclick = saveDay;
        
        // Job edit modal events
        $('job-edit-close').onclick = closeJobEditModal;
        $('save-job-edit').onclick = saveJobEdit;
        $('delete-job').onclick = deleteJob;
        $('add-job-expense-row').onclick = ()=> addJobExpenseRow();

        // Seed example if empty (to make it feel alive)
        if (getCustomers().length===0) { setCustomers([{ id:'cus_demo', name:'Curtis Crandon' }]); }
        if (getJobs().length===0) { setJobs([{ id:'job_demo', name:'6042 Hall Road', clientId:'cus_demo', color:'#2f7afe', created:new Date().toISOString() }]); }

        // Update all existing entries with new wage rates
        updateAllWageRates();

        renderCalendar();
    })();
    </script>
</body>
</html>


